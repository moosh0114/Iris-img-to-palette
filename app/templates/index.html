<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Iris Img to Palette</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.12"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
      };
    </script>
    
    <script>
      (function () {
        try {
          const stored = localStorage.getItem("theme");
          if (stored === "dark" || !stored) {
            document.documentElement.classList.add("dark");
          }
        } catch (_) {}
      })();

      function toggleTheme() {
        const isDark = document.documentElement.classList.toggle("dark");
        try {
          localStorage.setItem("theme", isDark ? "dark" : "light");
        } catch (_) {}
        updateThemeButtonText();
      }

      function updateThemeButtonText() {
        const toggleLabel = document.getElementById("theme-toggle-label");
        if (!toggleLabel) return;
        const isDark = document.documentElement.classList.contains("dark");
        toggleLabel.textContent = isDark ? "Switch to Light" : "Switch to Dark";
      }

      document.addEventListener("DOMContentLoaded", updateThemeButtonText);
    </script>
  </head>
  <body class="m-0 bg-zinc-50 font-sans text-zinc-800 transition-colors duration-700 ease-in-out dark:bg-zinc-950 dark:text-zinc-100 [&_*]:transition-colors [&_*]:duration-700 [&_*]:ease-in-out">
    <div class="mx-auto max-w-[1100px] p-6" x-data="uploader()">
      <div class="flex flex-wrap items-baseline justify-between gap-4">
        <h1 class="m-0 text-xl">Iris Img to Palette</h1>
        <button
          class="inline-flex cursor-pointer items-center gap-2 rounded-[9px] border border-zinc-300 bg-zinc-200 px-3 py-[9px] text-zinc-800 disabled:cursor-not-allowed disabled:opacity-60 dark:border-zinc-700 dark:bg-zinc-800 dark:text-zinc-100"
          type="button"
          onclick="toggleTheme()"
        >
          <span id="theme-toggle-label">Switch to Dark</span>
        </button>
      </div>
      <div class="text-[13px] text-zinc-600 dark:text-zinc-300">FastAPI + Strawberry GraphQL + HTMX + Alpine.js - results saved to SQLite</div>

      <div class="mt-4 grid grid-cols-1 gap-4 min-[981px]:grid-cols-[1fr_1fr_360px]">
        <div class="rounded-[10px] border border-zinc-300 bg-white p-3 dark:border-zinc-700 dark:bg-zinc-900">
          <div class="mb-[10px] text-[13px] text-zinc-600 dark:text-zinc-300">
            Upload an image and extract dominant colors (HEX + OKLCH).
          </div>

          <form
            hx-post="/api/extract"
            hx-target="#result"
            hx-swap="innerHTML"
            hx-indicator="#busy"
            enctype="multipart/form-data"
          >
            <label for="image-upload" class="mb-[6px] mt-[10px] block text-[13px] text-zinc-800 dark:text-zinc-100">Image</label>
            <input
              id="image-upload"
              class="box-border w-full rounded-lg border border-zinc-300 bg-white p-2 text-zinc-800 dark:border-zinc-700 dark:bg-zinc-950 dark:text-zinc-100"
              name="image"
              type="file"
              accept="image/*"
              required
              @change="onPick($event)"
            />

            <label for="n-colors-input" class="mb-[6px] mt-[10px] block text-[13px] text-zinc-800 dark:text-zinc-100">n_colors</label>
            <div class="flex items-stretch gap-2">
              <input
                id="n-colors-input"
                x-model="nColors"
                class="box-border w-full rounded-lg border border-zinc-300 bg-white p-2 text-zinc-800 dark:border-zinc-700 dark:bg-zinc-950 dark:text-zinc-100"
                name="n_colors"
                type="text"
                inputmode="numeric"
                pattern="[0-9]*"
                @input="sanitizeNColors()"
                @blur="sanitizeNColors()"
              />
              <div class="flex w-9 flex-col gap-1">
                <button
                  type="button"
                  class="inline-flex flex-1 items-center justify-center rounded-md border border-zinc-300 bg-zinc-200 text-zinc-800 dark:border-zinc-700 dark:bg-zinc-800 dark:text-zinc-100"
                  @click="stepNColors(1)"
                  aria-label="Increase n_colors"
                >
                  +
                </button>
                <button
                  type="button"
                  class="inline-flex flex-1 items-center justify-center rounded-md border border-zinc-300 bg-zinc-200 text-zinc-800 dark:border-zinc-700 dark:bg-zinc-800 dark:text-zinc-100"
                  @click="stepNColors(-1)"
                  aria-label="Decrease n_colors"
                >
                  -
                </button>
              </div>
            </div>

            <button
              class="mt-3 inline-flex cursor-pointer items-center gap-2 rounded-[9px] border border-zinc-300 bg-zinc-200 px-3 py-[9px] text-zinc-800 disabled:cursor-not-allowed disabled:opacity-60 dark:border-zinc-700 dark:bg-zinc-800 dark:text-zinc-100"
              type="submit"
            >
              Extract
            </button>
            <span id="busy" class="htmx-indicator text-[13px] text-zinc-600 dark:text-zinc-300" hx-indicator>Working...</span>
          </form>
        </div>

        <div class="rounded-[10px] border border-zinc-300 bg-white p-3 dark:border-zinc-700 dark:bg-zinc-900">
          <div class="mb-[10px] text-[13px] text-zinc-600 dark:text-zinc-300">Preview</div>
          <template x-if="previewUrl">
            <img
              class="max-h-[360px] w-full rounded-[10px] border border-zinc-300 bg-zinc-100 object-contain dark:border-zinc-700 dark:bg-zinc-950"
              :src="previewUrl"
              alt="preview"
            />
          </template>
          <template x-if="!previewUrl">
            <div class="text-[13px] text-zinc-600 dark:text-zinc-300">No image selected.</div>
          </template>
        </div>

        <div class="rounded-[10px] border border-zinc-300 bg-white p-3 dark:border-zinc-700 dark:bg-zinc-900">
          <div class="mb-[10px] flex items-center justify-between gap-[10px]">
            <div class="text-[13px] text-zinc-600 dark:text-zinc-300">History</div>
            <button
              class="inline-flex cursor-pointer items-center gap-2 rounded-[9px] border border-zinc-300 bg-zinc-200 px-[10px] py-[6px] text-xs text-zinc-800 disabled:cursor-not-allowed disabled:opacity-60 dark:border-zinc-700 dark:bg-zinc-800 dark:text-zinc-100"
              type="button"
              hx-post="/api/history/clear"
              hx-target="#history"
              hx-swap="innerHTML"
              hx-confirm="Clear all history records?"
            >
              Clear History
            </button>
          </div>
          <div id="history" hx-get="/history" hx-trigger="load" hx-swap="innerHTML">
            <div class="text-[13px] text-zinc-600 dark:text-zinc-300">Loading...</div>
          </div>
        </div>
      </div>

      <div class="mt-4">
        <div class="rounded-[10px] border border-zinc-300 bg-white p-3 dark:border-zinc-700 dark:bg-zinc-900" id="result">
          <div class="text-[13px] text-zinc-600 dark:text-zinc-300">Result will appear here.</div>
        </div>
      </div>
    </div>

    <script>
      function uploader() {
        return {
          nColors: "3",
          previewUrl: "",
          sanitizeNColors() {
            const digits = String(this.nColors ?? "").replace(/[^\d]/g, "");
            let value = parseInt(digits || "3", 10);
            if (Number.isNaN(value)) value = 3;
            this.nColors = String(Math.min(12, Math.max(1, value)));
          },
          stepNColors(delta) {
            const current = parseInt(this.nColors, 10);
            const base = Number.isNaN(current) ? 3 : current;
            this.nColors = String(Math.min(12, Math.max(1, base + delta)));
          },
          onPick(e) {
            const f = e?.target?.files?.[0];
            if (!f) {
              this.previewUrl = "";
              return;
            }
            this.previewUrl = URL.createObjectURL(f);
          },
        };
      }
    </script>
  </body>
</html>

